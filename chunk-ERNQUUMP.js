import{a as c,b as h,c as m,j as p,m as g,ua as w,wa as y}from"./chunk-NZYDAHZG.js";var f=class l{constructor(t){this.authService=t;this.resetData()}tickets=[];nextTicketNumber=106;getRandomDelay(){return 250+Math.floor(Math.random()*1750)}withDelay(t){return new m(r=>{let e=this.getRandomDelay(),i=setTimeout(()=>{r.next(t),r.complete()},e);return()=>clearTimeout(i)})}withDelayError(t){return new m(r=>{let e=this.getRandomDelay(),i=setTimeout(()=>{r.error(t)},e);return()=>clearTimeout(i)})}resetData(){this.tickets=JSON.parse(JSON.stringify(w)).map(t=>h(c({},t),{createdAt:new Date(t.createdAt),updatedAt:new Date(t.updatedAt)})),this.nextTicketNumber=106}getTickets(t=1,r=10,e,i="updatedAt",a="desc"){let s=[...this.tickets],d=this.authService.currentUser;if(d?.role==="agent"&&(s=s.filter(n=>n.assignedToUsername===d.username)),e){if(e.search){let n=e.search.toLowerCase();s=s.filter(o=>o.title.toLowerCase().includes(n)||o.description.toLowerCase().includes(n)||o.id.toLowerCase().includes(n))}e.status&&(s=s.filter(n=>n.status===e.status)),e.priority&&(s=s.filter(n=>n.priority===e.priority)),e.assignedTo&&(e.assignedTo==="me"?s=s.filter(n=>n.assignedToUsername===d?.username):e.assignedTo!=="all"&&(s=s.filter(n=>n.assignedToUsername===e.assignedTo))),e.customerId&&(s=s.filter(n=>n.customerId===e.customerId))}s.sort((n,o)=>{let u=0;switch(i){case"updatedAt":u=new Date(n.updatedAt).getTime()-new Date(o.updatedAt).getTime();break;case"createdAt":u=new Date(n.createdAt).getTime()-new Date(o.createdAt).getTime();break;case"priority":let k={Critical:4,High:3,Medium:2,Low:1};u=k[n.priority]-k[o.priority];break;case"status":u=n.status.localeCompare(o.status);break;case"title":u=n.title.localeCompare(o.title);break}return a==="asc"?u:-u});let D=s.length,T=(t-1)*r,v=T+r,b=s.slice(T,v);return this.withDelay({tickets:b,total:D})}getTicketById(t){let r=this.tickets.find(i=>i.id===t),e=this.authService.currentUser;return r&&e?.role==="agent"&&r.assignedToUsername!==e.username?this.withDelay(null):this.withDelay(r?c({},r):null)}getTicketsByCustomerId(t){let r=this.tickets.filter(i=>i.customerId===t),e=this.authService.currentUser;return e?.role==="agent"&&(r=r.filter(i=>i.assignedToUsername===e.username)),this.withDelay(r.map(i=>c({},i)))}getRecentTickets(t=5){let r=[...this.tickets],e=this.authService.currentUser;e?.role==="agent"&&(r=r.filter(a=>a.assignedToUsername===e.username));let i=r.sort((a,s)=>new Date(s.updatedAt).getTime()-new Date(a.updatedAt).getTime()).slice(0,t);return this.withDelay(i.map(a=>c({},a)))}getTicketStats(){let t=this.authService.currentUser,r=[...this.tickets];t?.role==="agent"&&(r=r.filter(i=>i.assignedToUsername===t.username));let e={open:r.filter(i=>i.status==="Open").length,assignedToMe:r.filter(i=>i.assignedToUsername===t?.username).length,total:r.length};return this.withDelay(e)}createTicket(t){if(t.title.includes("FAIL_CREATE"))return this.withDelayError(new Error("Failed to create ticket: The ticket system is currently experiencing issues. Please try again later."));let r=`TKT-${String(this.nextTicketNumber++).padStart(3,"0")}`,e=new Date,i={id:r,title:t.title,description:t.description,status:"Open",priority:t.priority,createdAt:e,updatedAt:e,customerId:t.customerId,assignedToUsername:t.assignedToUsername,tags:t.tags};return this.tickets.push(i),this.withDelay(c({},i))}updateTicket(t,r){let e=this.tickets.findIndex(s=>s.id===t);if(e===-1)return this.withDelayError(new Error("Ticket not found"));let i=this.authService.currentUser,a=this.tickets[e];return i?.role==="agent"&&a.assignedToUsername!==i.username?this.withDelayError(new Error("You do not have permission to edit this ticket")):(this.tickets[e]=h(c(c({},this.tickets[e]),r),{updatedAt:new Date}),this.withDelay(c({},this.tickets[e])))}deleteTicket(t){if(this.authService.currentUser?.role!=="admin")return this.withDelayError(new Error("Only administrators can delete tickets"));if(t==="TKT-001")return this.withDelayError(new Error("Cannot delete ticket: This ticket is linked to an active SLA agreement and cannot be removed. Please contact your administrator."));let e=this.tickets.findIndex(i=>i.id===t);return e===-1?this.withDelayError(new Error("Ticket not found")):(this.tickets.splice(e,1),this.withDelay(!0))}static \u0275fac=function(r){return new(r||l)(g(y))};static \u0275prov=p({token:l,factory:l.\u0275fac,providedIn:"root"})};export{f as a};
