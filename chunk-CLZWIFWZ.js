import{a as c,b as m,c as h,j as k,m as g,ua as f,wa as w}from"./chunk-WLOU5G26.js";var y=class d{constructor(r){this.authService=r;this.resetData()}tickets=[];nextTicketNumber=106;getRandomDelay(){return 250+Math.floor(Math.random()*750)}withDelay(r){return new h(t=>{let e=this.getRandomDelay(),i=setTimeout(()=>{t.next(r),t.complete()},e);return()=>clearTimeout(i)})}withDelayError(r){return new h(t=>{let e=this.getRandomDelay(),i=setTimeout(()=>{t.error(r)},e);return()=>clearTimeout(i)})}resetData(){this.tickets=JSON.parse(JSON.stringify(f)).map(r=>m(c({},r),{createdAt:new Date(r.createdAt),updatedAt:new Date(r.updatedAt)})),this.nextTicketNumber=106}getTickets(r=1,t=10,e,i="updatedAt",a="desc"){let s=[...this.tickets],l=this.authService.currentUser;if(l?.role==="agent"&&(s=s.filter(n=>n.assignedToUsername===l.username)),e){if(e.search){let n=e.search.toLowerCase();s=s.filter(o=>o.title.toLowerCase().includes(n)||o.description.toLowerCase().includes(n)||o.id.toLowerCase().includes(n))}e.status&&(s=s.filter(n=>n.status===e.status)),e.priority&&(s=s.filter(n=>n.priority===e.priority)),e.assignedTo&&(e.assignedTo==="me"?s=s.filter(n=>n.assignedToUsername===l?.username):e.assignedTo!=="all"&&(s=s.filter(n=>n.assignedToUsername===e.assignedTo))),e.customerId&&(s=s.filter(n=>n.customerId===e.customerId))}s.sort((n,o)=>{let u=0;switch(i){case"updatedAt":u=new Date(n.updatedAt).getTime()-new Date(o.updatedAt).getTime();break;case"createdAt":u=new Date(n.createdAt).getTime()-new Date(o.createdAt).getTime();break;case"priority":let p={Critical:4,High:3,Medium:2,Low:1};u=p[n.priority]-p[o.priority];break;case"status":u=n.status.localeCompare(o.status);break;case"title":u=n.title.localeCompare(o.title);break}return a==="asc"?u:-u});let D=s.length,T=(r-1)*t,b=T+t,v=s.slice(T,b);return this.withDelay({tickets:v,total:D})}getTicketById(r){let t=this.tickets.find(i=>i.id===r),e=this.authService.currentUser;return t&&e?.role==="agent"&&t.assignedToUsername!==e.username?this.withDelay(null):this.withDelay(t?c({},t):null)}getTicketsByCustomerId(r){let t=this.tickets.filter(i=>i.customerId===r),e=this.authService.currentUser;return e?.role==="agent"&&(t=t.filter(i=>i.assignedToUsername===e.username)),this.withDelay(t.map(i=>c({},i)))}getRecentTickets(r=5){let t=[...this.tickets],e=this.authService.currentUser;e?.role==="agent"&&(t=t.filter(a=>a.assignedToUsername===e.username));let i=t.sort((a,s)=>new Date(s.updatedAt).getTime()-new Date(a.updatedAt).getTime()).slice(0,r);return this.withDelay(i.map(a=>c({},a)))}getTicketStats(){let r=this.authService.currentUser,t=[...this.tickets];r?.role==="agent"&&(t=t.filter(i=>i.assignedToUsername===r.username));let e={open:t.filter(i=>i.status==="Open").length,assignedToMe:t.filter(i=>i.assignedToUsername===r?.username).length,total:t.length};return this.withDelay(e)}createTicket(r){let t=`TKT-${String(this.nextTicketNumber++).padStart(3,"0")}`,e=new Date,i={id:t,title:r.title,description:r.description,status:"Open",priority:r.priority,createdAt:e,updatedAt:e,customerId:r.customerId,assignedToUsername:r.assignedToUsername,tags:r.tags};return this.tickets.push(i),this.withDelay(c({},i))}updateTicket(r,t){let e=this.tickets.findIndex(s=>s.id===r);if(e===-1)return this.withDelayError(new Error("Ticket not found"));let i=this.authService.currentUser,a=this.tickets[e];return i?.role==="agent"&&a.assignedToUsername!==i.username?this.withDelayError(new Error("You do not have permission to edit this ticket")):(this.tickets[e]=m(c(c({},this.tickets[e]),t),{updatedAt:new Date}),this.withDelay(c({},this.tickets[e])))}deleteTicket(r){if(this.authService.currentUser?.role!=="admin")return this.withDelayError(new Error("Only administrators can delete tickets"));let e=this.tickets.findIndex(i=>i.id===r);return e===-1?this.withDelayError(new Error("Ticket not found")):(this.tickets.splice(e,1),this.withDelay(!0))}static \u0275fac=function(t){return new(t||d)(g(w))};static \u0275prov=k({token:d,factory:d.\u0275fac,providedIn:"root"})};export{y as a};
